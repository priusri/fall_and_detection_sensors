{% extends "base.html" %}
{% block content %}
<div class="card status-card">
    <h2>Current Status</h2>
    <div id="status-indicator" class="status-indicator status-unknown">
        --
    </div>
    <div id="last-updated" style="color: #64748b; margin-bottom: 20px;">
        Waiting for data...
    </div>

    <div id="map-container" style="display:none;">
        <p>Location Coordinates:</p>
        <div class="coords-box">
            <span id="coords-text"></span>
        </div>
        <br>
        <a id="maps-link" href="#" target="_blank" class="btn">View on Google Maps</a>
    </div>
</div>

<script>
    function updateStatus() {
        fetch('/api/fall_status')
            .then(response => response.json())
            .then(data => {
                const indicator = document.getElementById('status-indicator');
                const lastUpdated = document.getElementById('last-updated');
                const mapContainer = document.getElementById('map-container');
                const coordsText = document.getElementById('coords-text');
                const mapsLink = document.getElementById('maps-link');

                if (data.status) {
                    if (data.status === 'Active') {
                        indicator.textContent = 'FALL DETECTED';
                        indicator.className = 'status-indicator status-danger';
                    } else {
                        indicator.textContent = 'Safe';
                        indicator.className = 'status-indicator status-safe';
                    }

                    lastUpdated.textContent = 'Last Event: ' + data.timestamp;

                    if (data.lat && data.long) {
                        mapContainer.style.display = 'block';
                        coordsText.textContent = `${data.lat}, ${data.long}`;
                        mapsLink.href = `https://www.google.com/maps/search/?api=1&query=${data.lat},${data.long}`;
                    }
                } else {
                    indicator.textContent = 'System Active - No Events';
                    indicator.className = 'status-indicator status-safe';
                    lastUpdated.textContent = 'No events recorded yet.';
                    mapContainer.style.display = 'none';
                }
            })
            .catch(error => console.error('Error fetching status:', error));
    }

    // Poll every 5 seconds
    setInterval(updateStatus, 5000);
    updateStatus(); // Initial call
</script>
{% endblock %}